---
title: "Profile";

import type { Client } from "@/consts/types";
import type { Session } from "@auth/core/types";

import Layout from "@/layouts/Layout.astro";
import Main from "@/components/Main.astro";
import Profile_section from "@/sections/Profile_section.astro";

import { fetchClientByEmail } from "@/services/server_side_fetch";
import { getSession } from "auth-astro/server";


let registroCompletado: boolean = false;
let client: Client | undefined = undefined;
let profilePhotoSrc: string | null = null;

try {
  const session: Session | null = await getSession(Astro.request);
  // If google login doesn't return name or email
  if (!session || !session.user?.name || !session.user.email)
    throw new Error("Google login didn't return valid data.");
  // If google login doesn't return name or email
  client = await fetchClientByEmail(session?.user?.email);
  // If client is registered
  if (client) {
    registroCompletado = true;
  } else {
    throw new Error("Client is not registered.");
  }
  // profile photo
  profilePhotoSrc = client?.image || session?.user.image || "/images/default_profile.png";
} catch (error) {
  console.error(error);
}
---
<Layout title="Profile">
    <Main>
      {registroCompletado ? (
        <Profile_section profilePhotoSrc={profilePhotoSrc}>
          <h1 slot="header">Este es el encabezado</h1>
          <p>{ /*profileType*/ }</p>
          <p>Este es el contenido principal</p>
          <p slot="user">usuario: { client?.username }</p>
          <p slot="id">id: { client?.id }</p>
          <p slot="mail">mail: { client?.email }</p>
        </Profile_section>
      ) : (
        <p>No hay imagen de perfil disponible.</p>
      )}
    </Main>
</Layout>